<!DOCTYPE html>
<html>
<head>
    <title>Procurement Analytics Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... (keep all CSS styles the same) ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Procurement Analytics Tool</h1>
        <input type="file" id="fileInput" accept=".csv">
        <div id="keyInsights" class="key-insights"></div>
        <div id="results"></div>
    </div>

    <script>
        const colors = ['#5D8696', '#78ABAF', '#8FAFCC', '#CCA885', '#D9DAD4'];
        
        document.getElementById('fileInput').addEventListener('change', handleFile);

        function parseCSV(text) {
            const rows = text.split('\n').slice(1).filter(row => row.trim() !== '');
            return rows.map(row => {
                const cells = row.split(',');
                return {
                    Supplier: cells[1],
                    Order_Date: new Date(cells[2]),
                    Expected_Delivery_Date: new Date(cells[3]),
                    Actual_Delivery_Date: new Date(cells[4]),
                    Product_Category: cells[5],
                    Transportation_Mode: cells[6],
                    Disruption_Type: cells[8]
                };
            });
        }

        async function handleFile(e) {
            const file = e.target.files[0];
            const text = await file.text();
            const data = parseCSV(text);
            
            const results = document.getElementById('results');
            const keyInsights = document.getElementById('keyInsights');
            results.innerHTML = '';
            keyInsights.innerHTML = '<h2>Key Insights</h2>';

            const insights = [];
            
            insights.push(processQuestion1(data, results));
            insights.push(processQuestion2(data, results));
            insights.push(processQuestion3(data, results));
            insights.push(processQuestion4(data, results));
            insights.push(processQuestion5(data, results));

            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = 'insight-item';
                div.innerHTML = `
                    <span style="color: #5D8696;">${insight.title}:</span>
                    <span class="insight-value">${insight.value}</span>
                `;
                keyInsights.appendChild(div);
            });
        }

        function calculateLeadTime(startDate, endDate) {
            return Math.ceil((endDate - startDate) / (1000 * 3600 * 24));
        }

        // Question Processing Functions
        function processQuestion1(data, container) {
            const leadTimes = data.reduce((acc, row) => {
                const lt = calculateLeadTime(row.Order_Date, row.Actual_Delivery_Date);
                acc[row.Supplier] = acc[row.Supplier] || [];
                acc[row.Supplier].push(lt);
                return acc;
            }, {});

            const averages = Object.entries(leadTimes).map(([supplier, times]) => ({
                supplier,
                average: times.reduce((a, b) => a + b, 0) / times.length
            }));

            const max = averages.reduce((a, b) => a.average > b.average ? a : b);
            
            const qDiv = createQuestionDiv('Supplier Lead Time Analysis');
            createBarChart(qDiv, 
                averages.map(x => x.supplier),
                averages.map(x => x.average),
                'Supplier',
                'Average Lead Time (days)',
                false
            );
            
            return {
                title: 'Highest Average Lead Time',
                value: `${max.supplier} (${max.average.toFixed(1)} days)`
            };
        }

        function processQuestion2(data, container) {
            const transportData = data.reduce((acc, row) => {
                const lt = calculateLeadTime(row.Order_Date, row.Actual_Delivery_Date);
                acc[row.Transportation_Mode] = acc[row.Transportation_Mode] || [];
                acc[row.Transportation_Mode].push(lt);
                return acc;
            }, {});

            const averages = Object.entries(transportData).map(([mode, times]) => ({
                mode,
                average: times.reduce((a, b) => a + b, 0) / times.length
            }));

            const min = averages.reduce((a, b) => a.average < b.average ? a : b);
            
            const qDiv = createQuestionDiv('Transportation Efficiency');
            const grid = createChartGrid();
            qDiv.appendChild(grid);
            
            createBarChart(grid, 
                averages.map(x => x.mode),
                averages.map(x => x.average),
                'Transportation Mode',
                'Average Days',
                true
            );
            
            return {
                title: 'Most Efficient Transportation',
                value: `${min.mode} (${min.average.toFixed(1)} days)`
            };
        }

        // Add other question processing functions (Q3-Q5) following the same pattern

        function createQuestionDiv(title) {
            const div = document.createElement('div');
            div.className = 'question-box';
            div.innerHTML = `<h3 style="color: #5D8696; margin-bottom: 15px;">${title}</h3>`;
            document.getElementById('results').appendChild(div);
            return div;
        }

        function createChartGrid() {
            const grid = document.createElement('div');
            grid.className = 'chart-grid';
            return grid;
        }

        function createBarChart(container, labels, data, xLabel, yLabel, horizontal = false) {
            const canvas = document.createElement('canvas');
            const card = document.createElement('div');
            card.className = 'chart-card';
            card.appendChild(canvas);
            container.appendChild(card);

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: horizontal ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y || context.parsed.x} days`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: horizontal ? xLabel : yLabel }
                        },
                        x: {
                            title: { display: true, text: horizontal ? yLabel : xLabel }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
